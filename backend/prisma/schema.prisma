generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  FAN
  ARTIST
  ADMIN
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  role         Role
  appRole      String   @default("user")
  authProvider String   @default("email")
  onboardingCompleted Boolean @default(false)
  lastLoginAt  DateTime?
  name         String?
  picture      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model TierProgress {
  id         String   @id @default(cuid())
  userId     String   @unique
  attendance Int      @default(0)
  spendUsd   Decimal  @db.Decimal(10, 2)
  tier       Int      @default(0)
  updatedAt  DateTime @updatedAt
}

model JourneyTierConfig {
  id         String   @id @default(cuid())
  code       String   @unique
  title      String
  requiredXp Int
  perkLabel  String
  sortOrder  Int
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model XpActionConfig {
  id        String   @id @default(cuid())
  code      String   @unique
  label     String
  xpValue   Int
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BandReward {
  id             String   @id @default(cuid())
  title          String
  description    String
  triggerType    String
  xpBonus        Int      @default(0)
  active         Boolean  @default(true)
  createdByEmail String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model BandStoreItem {
  id        String   @id @default(cuid())
  name      String
  fiatPrice Decimal  @db.Decimal(10, 2)
  imageUrl  String
  limited   Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BandConcert {
  id        String   @id @default(cuid())
  title     String
  venue     String
  city      String
  startsAt  DateTime
  priceEur  Decimal  @db.Decimal(10, 2)
  ticketUrl String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  registrations BandConcertRegistration[]
}

model BandLive {
  id         String   @id @default(cuid())
  artist     String
  title      String
  startsAt   DateTime
  viewers    Int      @default(0)
  rewardHint String
  genre      String
  colorClass String   @default("stream-a")
  youtubeUrl String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  subscriptions BandLiveSubscription[]
}

model BandLiveSubscription {
  id         String   @id @default(cuid())
  liveId     String
  userEmail  String
  userName   String?
  source     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  live       BandLive @relation(fields: [liveId], references: [id], onDelete: Cascade)

  @@unique([liveId, userEmail])
  @@index([userEmail])
}

model BandSale {
  id             String   @id @default(cuid())
  userEmail      String
  customerEmail  String
  customerName   String?
  productId      String
  productName    String
  itemType       String
  amountEur      Decimal  @db.Decimal(10, 2)
  status         String
  stripeSessionId String? @unique
  paymentIntentId String? @unique
  paidAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  registrations  BandConcertRegistration[]
}

model BandConcertRegistration {
  id         String   @id @default(cuid())
  concertId  String
  userEmail  String
  userName   String?
  status     String
  source     String
  saleId     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  concert    BandConcert @relation(fields: [concertId], references: [id], onDelete: Cascade)
  sale       BandSale?   @relation(fields: [saleId], references: [id], onDelete: SetNull)

  @@unique([concertId, userEmail])
  @@index([userEmail])
  @@index([status])
}
